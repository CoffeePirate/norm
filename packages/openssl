#!/bin/bash
depends_on zlib

## don't use https to download openssl source because openssl might be too old to even establish a connection!
fetch_source ftp://ftp.openssl.org/source/openssl-1.0.1l.tar.gz 4547a0b4269acf76b1f9e7d188896867d6fc8c18

BUILDCONF=gcc
[[ $OSTYPE == *linux* ]] && [[ $HOSTTYPE == i?86 ]] && BUILDCONF=linux-elf
[[ $OSTYPE == *linux* ]] && [[ $HOSTTYPE == x86_64 ]] && BUILDCONF=linux-x86_64
[[ $OSTYPE == *darwin* ]] && BUILDCONF=darwin64-x86_64-cc
SSLCONFIG="no-idea no-mdc2 no-rc5 zlib enable-tlsext no-ssl2 enable-cms --openssldir=$PREFIX/etc/ssl"

do_unpack
pushd_src

## make both static and shared versions
./Configure no-shared --prefix=$PREFIX $LDFLAGS $SSLCONFIG $BUILDCONF
make depend
make all
make test
mv libcrypto.a libcrypto.static
mv libssl.a libssl.static
make -f Makefile clean
./Configure shared --prefix=$PREFIX $LDFLAGS $SSLCONFIG $BUILDCONF
make depend
make all
make test
do_install MANDIR=$PREFIX/share/man
cp -pf libcrypto.static $PREFIX/lib/libcrypto.a
cp -pf libssl.static $PREFIX/lib/libssl.a
popd
log_success
