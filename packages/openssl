#!/bin/bash
fetch_source https://github.com/openssl/openssl/archive/OpenSSL_1_0_1l.tar.gz af7e23d5fe6d98ae98144bc78314cb21860c582f

depends_on zlib libgmp

BUILDCONF=gcc
[[ $OSTYPE == *linux* ]] && [[ $HOSTTYPE == i?86 ]] && BUILDCONF=linux-elf
[[ $OSTYPE == *linux* ]] && [[ $HOSTTYPE == x86_64 ]] && BUILDCONF=linux-x86_64
[[ $OSTYPE == *darwin* ]] && BUILDCONF=darwin64-x86_64-cc
SSLCONFIG="no-idea no-mdc2 no-rc5 zlib enable-tlsext no-ssl2 enable-cms enable-gmp -lgmp"

do_unpack openssl-OpenSSL_1_0_1l OpenSSL_1_0_1l.tar.gz
pushd_src

./Configure no-shared --prefix=$PREFIX $LDFLAGS $SSLCONFIG $BUILDCONF
make depend
make all
make test
mv libcrypto.a libcrypto.static
mv libssl.a libssl.static
make -f Makefile clean
./Configure shared --prefix=$PREFIX $LDFLAGS $SSLCONFIG $BUILDCONF
make depend
make all
make test
do_install MANDIR=$PREFIX/share/man
cp -pf libcrypto.static $PREFIX/lib/libcrypto.a
cp -pf libssl.static $PREFIX/lib/libssl.a
popd
log_success
